@page "/Account/Login"
@layout UnauthenticatedLayout
@using Microsoft.AspNetCore.Authentication
@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.Components.Web
@using IndxCloudApi.Data
@using System.ComponentModel.DataAnnotations
@inject SignInManager<ApplicationUser> SignInManager
@inject NavigationManager NavigationManager
@inject ILogger<Login> Logger

<PageTitle>Log in</PageTitle>

<h3>Log in to Indx Cloud API</h3>

@if (!string.IsNullOrEmpty(errorMessage))
{
    <div style="padding: 20px; border: 1px solid var(--CSignal); border-radius: var(--radius); background: rgba(255, 66, 56, 0.1); margin: 20px 0;">
        @errorMessage
    </div>
}

<!-- External Login Buttons -->
@if (externalLogins == null)
{
    <div style="text-align: center; margin: 20px 0;">
        <p>Loading...</p>
    </div>
}
else if (externalLogins.Count > 0)
{
    <div style="display: grid; gap: 10px;">
        @foreach (var provider in externalLogins)
        {
            <form action="Account/PerformExternalLogin" method="post">
                <AntiforgeryToken />
                <input type="hidden" name="provider" value="@provider.Name" />
                <input type="hidden" name="returnUrl" value="@ReturnUrl" />
                <button type="submit" class="btn-primary">
                    @if (provider.Name == "Google")
                    {
                        <span>Sign in with Google</span>
                    }
                    else if (provider.Name == "Microsoft")
                    {
                        <span>Sign in with Microsoft</span>
                    }
                    else
                    {
                        <span>Sign in with @provider.DisplayName</span>
                    }
                </button>
            </form>
        }
    </div>

    <div style="margin-top: 40px; margin-bottom: 20px; font: var(--text-sm); color: var(--lv6);">
        Or use your credentials
    </div>
}

<!-- Local Account Login -->
<EditForm Model="Input" method="post" OnValidSubmit="LoginUser" FormName="login">
    <DataAnnotationsValidator />
    <ValidationSummary style="color: var(--CSignal);" role="alert" />

    <div style="margin-bottom: 10px;">
        <InputText @bind-Value="Input.Email"
                   type="email"
                   autocomplete="username"
                   placeholder="Email"
                   id="email" />
        <ValidationMessage For="() => Input.Email" />
    </div>

    <div style="margin-bottom: 10px;">
        <InputText type="password"
                   @bind-Value="Input.Password"
                   autocomplete="current-password"
                   placeholder="Password"
                   id="password" />
        <ValidationMessage For="() => Input.Password" />
    </div>

    <div style="margin-bottom: 20px; display: flex; align-items: center; gap: 8px;">
        <InputCheckbox @bind-Value="Input.RememberMe"
                       id="rememberMe" />
        <label for="rememberMe" style="margin: 0; cursor: pointer;">
            Remember me
        </label>
    </div>

    <button type="submit" class="btn-secondary">Log in</button>

    <div style="margin-top: 40px; display: flex; flex-direction: column;">
        <a href="/Account/Register?returnUrl=@ReturnUrl" style="font: var(--text-sm); margin-bottom: 20px;">Register as a new user</a>
        <a href="/Account/ForgotPassword" style="font: var(--text-xs); margin-bottom: 5px;">Forgot your password?</a>
        <a href="/Account/ResendEmailConfirmation" style="font: var(--text-xs);">Resend email confirmation</a>
    </div>
</EditForm>

@code {
    private string? errorMessage;
    private IList<AuthenticationScheme>? externalLogins;

    [CascadingParameter]
    private HttpContext HttpContext { get; set; } = default!;

    [SupplyParameterFromForm]
    private InputModel Input { get; set; } = new();

    [SupplyParameterFromQuery]
    private string? ReturnUrl { get; set; }

    [SupplyParameterFromQuery]
    private string? Error { get; set; }

    protected override async Task OnInitializedAsync()
    {
        // Set error message from query parameter if present
        if (!string.IsNullOrEmpty(Error))
        {
            errorMessage = Error;
        }

        // Get available external authentication schemes
        externalLogins = (await SignInManager.GetExternalAuthenticationSchemesAsync()).ToList();

        Logger.LogInformation("Login page loaded. Found {Count} external login providers", externalLogins.Count);

        if (HttpMethods.IsGet(HttpContext.Request.Method))
        {
            // Clear the existing external cookie to ensure a clean login process
            await HttpContext.SignOutAsync(IdentityConstants.ExternalScheme);
        }
    }

    private async Task LoginUser()
    {
        // Sign in the user with password
        var result = await SignInManager.PasswordSignInAsync(
            Input.Email,
            Input.Password,
            Input.RememberMe,
            lockoutOnFailure: false);

        if (result.Succeeded)
        {
            Logger.LogInformation("User {Email} logged in successfully", Input.Email);

            // ✅ ENDRING: Redirect til API Key page i stedet for home
            NavigationManager.NavigateTo("/Account/ApiKey", forceLoad: true);
        }
        else if (result.RequiresTwoFactor)
        {
            NavigationManager.NavigateTo($"/Account/LoginWith2fa?returnUrl={ReturnUrl}", forceLoad: true);
        }
        else if (result.IsLockedOut)
        {
            Logger.LogWarning("User {Email} account locked out", Input.Email);
            NavigationManager.NavigateTo("/Account/Lockout");
        }
        else
        {
            Logger.LogWarning("Invalid login attempt for {Email}", Input.Email);
            errorMessage = "Error: Invalid login attempt.";
        }
    }

    private sealed class InputModel
    {
        [Required]
        [EmailAddress]
        public string Email { get; set; } = "";

        [Required]
        [DataType(DataType.Password)]
        public string Password { get; set; } = "";

        [Display(Name = "Remember me?")]
        public bool RememberMe { get; set; }
    }
}